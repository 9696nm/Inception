# ============================================================================ #
#                          NGINX Dockerfile                                    #
# ============================================================================ #
# Debian ベースの NGINX コンテナを構築
# TLSv1.2/1.3 のみをサポートし、WordPress へリバースプロキシ
# ============================================================================ #

# ---------------------------------------------------------------------------- #
# ベースイメージ：Debian 11 (bullseye) - 安定版の一つ前のバージョン
# ---------------------------------------------------------------------------- #

FROM	debian:bullseye

# ---------------------------------------------------------------------------- #
# メタデータ
# ---------------------------------------------------------------------------- #

LABEL	maintainer="hmori" \
		description="NGINX with TLS for Inception project"

# ---------------------------------------------------------------------------- #
# パッケージのインストール
# ---------------------------------------------------------------------------- #

RUN		apt-get update && apt-get install -y \
		# NGINX ウェブサーバー
		nginx \
		# OpenSSL：自己署名証明書の生成に使用
		openssl \
		# Tini：軽量 init システム（ゾンビプロセス対策・シグナル転送）
		tini \
		# 不要なファイルを削除してイメージサイズを削減
		&& apt-get clean \
		&& rm -rf /var/lib/apt/lists/*

# ---------------------------------------------------------------------------- #
# SSL/TLS 証明書用ディレクトリの作成
# ---------------------------------------------------------------------------- #

# SSL ディレクトリを作成（証明書は起動時スクリプトで生成）
RUN		mkdir -p /etc/nginx/ssl

# ---------------------------------------------------------------------------- #
# セットアップスクリプトのコピー
# ---------------------------------------------------------------------------- #

# SSL 証明書生成と NGINX 起動を行うスクリプトをコピー
COPY	tools/setup-nginx.sh /usr/local/bin/setup-nginx.sh

# スクリプトに実行権限を付与
RUN		chmod +x /usr/local/bin/setup-nginx.sh

# ---------------------------------------------------------------------------- #
# 設定ファイルのコピー
# ---------------------------------------------------------------------------- #

# カスタム NGINX 設定ファイルをコピー
COPY	conf/nginx.conf /etc/nginx/nginx.conf

# ---------------------------------------------------------------------------- #
# ポート公開
# ---------------------------------------------------------------------------- #

# HTTPS ポート 443 を公開
EXPOSE	443

# ---------------------------------------------------------------------------- #
# コンテナ起動コマンド
# ---------------------------------------------------------------------------- #

# Tini を PID 1 として起動（プロセス管理・シグナル転送を担当）
ENTRYPOINT	["/usr/bin/tini", "--"]

# セットアップスクリプトを実行
# このスクリプトが SSL 証明書の生成と NGINX の起動を行う
CMD			["/usr/local/bin/setup-nginx.sh"]

