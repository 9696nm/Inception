# ============================================================================ #
#                          NGINX 設定ファイル                                   #
# ============================================================================ #
# WordPress へのリバースプロキシとして機能
# TLSv1.2 と TLSv1.3 のみをサポート
# ============================================================================ #

# ---------------------------------------------------------------------------- #
# メインコンテキスト
# ---------------------------------------------------------------------------- #

# NGINX ワーカープロセスのユーザー
user www-data;

# ワーカープロセス数（auto = CPU コア数に自動調整）
worker_processes auto;

# PID ファイルの場所
pid /run/nginx.pid;

# エラーログの設定
error_log /var/log/nginx/error.log warn;

# ---------------------------------------------------------------------------- #
# イベントコンテキスト
# ---------------------------------------------------------------------------- #

events {
	# 1 つのワーカープロセスが同時に処理できる接続数
	worker_connections 1024;
}

# ---------------------------------------------------------------------------- #
# HTTP コンテキスト
# ---------------------------------------------------------------------------- #

http {
	# --------------------------------------------------------------------------
	# サーバーブロック（HTTPS）
	# --------------------------------------------------------------------------
	
	server {
		# ポート 443 で HTTPS（SSL/TLS）をリッスン
		listen 443 ssl;
		listen [::]:443 ssl;
		
		# サーバー名（環境変数から設定）
		server_name ${DOMAIN_NAME};

		# 一致を要求
		if ($host != $server_name) {
			return 444;
		}
		
		# ----------------------------------------------------------------------
		# SSL/TLS 設定
		# ----------------------------------------------------------------------
		
		# SSL 証明書のパス
		ssl_certificate /etc/nginx/ssl/nginx.crt;
		
		# SSL 秘密鍵のパス
		ssl_certificate_key /etc/nginx/ssl/nginx.key;
		
		# 使用する SSL/TLS プロトコル
		ssl_protocols TLSv1.2 TLSv1.3;
		
		# 使用する暗号スイート
		ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
		
		# サーバー側の暗号スイート優先
		ssl_prefer_server_ciphers off;
		
		# SSL セッションキャッシュ
		ssl_session_cache shared:SSL:10m;
		ssl_session_timeout 10m;

		# ----------------------------------------------------------------------
		# ロケーションブロック
		# ----------------------------------------------------------------------
		
		# メインロケーション：WordPress のパーマリンク処理
		location / {
			# まずファイルとして存在するか確認、次にディレクトリ、
			# それでもなければ index.php にリダイレクト
			try_files $uri $uri/ /index.php?$args;
		}
		
		# PHP ファイルの処理
		location ~ \.php$ {
			# セキュリティ：存在しないスクリプトへのリクエストを拒否
			try_files $uri =404;
			
			# パスの分割処理を有効化
			fastcgi_split_path_info ^(.+\.php)(/.+)$;
			
			# WordPress コンテナの PHP-FPM へリクエストを転送
			# wordpress:9000 は Docker Compose で定義されたサービス名とポート
			fastcgi_pass wordpress:9000;
			
			# デフォルトのインデックスファイル
			fastcgi_index index.php;
			
			# FastCGI パラメータを設定
			include fastcgi_params;
			
			# SCRIPT_FILENAME パラメータを設定
			fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
			
			# PATH_INFO パラメータを設定
			fastcgi_param PATH_INFO $fastcgi_path_info;
		}
	}
}

