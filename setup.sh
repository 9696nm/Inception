#!/bin/bash
# ============================================================================ #
#                       Inception プロジェクト セットアップ                      #
# ============================================================================ #
# このスクリプトは初回セットアップを支援します
# ============================================================================ #

set -e

# ---------------------------------------------------------------------------- #
# 色定義
# ---------------------------------------------------------------------------- #

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ---------------------------------------------------------------------------- #
# ロゴ表示
# ---------------------------------------------------------------------------- #

echo -e "${BLUE}"
cat << "EOF"
╔═══════════════════════════════════════════════════════════════╗
║                                                               ║
║              Inception プロジェクト セットアップ                ║
║                                                               ║
║                   Docker Compose Setup                        ║
║                                                               ║
╚═══════════════════════════════════════════════════════════════╝
EOF
echo -e "${NC}"

# ---------------------------------------------------------------------------- #
# 1. .env ファイルの作成
# ---------------------------------------------------------------------------- #

echo -e "${YELLOW}[1/4] .env ファイルの作成${NC}"

if [ -f "srcs/.env" ]; then
	echo -e "${GREEN}✓${NC} .env ファイルは既に存在します"
	read -p "上書きしますか？ (y/N): " -n 1 -r
	echo
	if [[ ! $REPLY =~ ^[Yy]$ ]]; then
		echo "スキップします"
	else
		cp srcs/env.sample srcs/.env
		echo -e "${GREEN}✓${NC} .env ファイルを作成しました"
	fi
else
	cp srcs/env.sample srcs/.env
	echo -e "${GREEN}✓${NC} .env ファイルを作成しました"
fi

echo ""

# ---------------------------------------------------------------------------- #
# 2. ユーザー名の取得と設定
# ---------------------------------------------------------------------------- #

echo -e "${YELLOW}[2/4] ユーザー設定${NC}"

# 現在のユーザー名を取得
CURRENT_USER=$(whoami)
echo "現在のユーザー名: ${CURRENT_USER}"

read -p "ドメイン名を入力してください (デフォルト: ${CURRENT_USER}.42.fr): " DOMAIN_NAME
DOMAIN_NAME=${DOMAIN_NAME:-${CURRENT_USER}.42.fr}

echo -e "${GREEN}✓${NC} ドメイン名: ${DOMAIN_NAME}"

# .env ファイルのドメイン名を更新
sed -i "s/DOMAIN_NAME=.*/DOMAIN_NAME=${DOMAIN_NAME}/" srcs/.env

# docker-compose.yml と Makefile のパスを更新
sed -i "s|/home/hmori/data|/home/${CURRENT_USER}/data|g" srcs/docker-compose.yml
sed -i "s|/home/hmori|/home/${CURRENT_USER}|g" Makefile

echo ""

# ---------------------------------------------------------------------------- #
# 3. /etc/hosts の設定
# ---------------------------------------------------------------------------- #

echo -e "${YELLOW}[3/4] /etc/hosts の設定${NC}"

if grep -q "${DOMAIN_NAME}" /etc/hosts; then
	echo -e "${GREEN}✓${NC} /etc/hosts に ${DOMAIN_NAME} は既に登録されています"
else
	echo "127.0.0.1    ${DOMAIN_NAME}" | sudo tee -a /etc/hosts > /dev/null
	echo -e "${GREEN}✓${NC} /etc/hosts に ${DOMAIN_NAME} を追加しました"
fi

echo ""

# ---------------------------------------------------------------------------- #
# 4. データディレクトリの作成
# ---------------------------------------------------------------------------- #

echo -e "${YELLOW}[4/4] データディレクトリの作成${NC}"

DATA_DIR="/home/${CURRENT_USER}/data"
mkdir -p ${DATA_DIR}/wordpress
mkdir -p ${DATA_DIR}/mariadb

echo -e "${GREEN}✓${NC} データディレクトリを作成しました: ${DATA_DIR}"

echo ""

# ---------------------------------------------------------------------------- #
# セットアップ完了
# ---------------------------------------------------------------------------- #

echo -e "${GREEN}"
cat << "EOF"
╔═══════════════════════════════════════════════════════════════╗
║                                                               ║
║                  セットアップが完了しました！                    ║
║                                                               ║
╚═══════════════════════════════════════════════════════════════╝
EOF
echo -e "${NC}"

echo -e "${BLUE}次のステップ:${NC}"
echo ""
echo "1. srcs/.env ファイルを編集してパスワードを変更してください："
echo -e "   ${YELLOW}nano srcs/.env${NC}"
echo ""
echo "2. プロジェクトをビルドして起動してください："
echo -e "   ${YELLOW}make${NC}"
echo ""
echo "3. ブラウザで以下にアクセスしてください："
echo -e "   ${YELLOW}https://${DOMAIN_NAME}${NC}"
echo ""
echo -e "${GREEN}頑張ってください！ 🚀${NC}"

